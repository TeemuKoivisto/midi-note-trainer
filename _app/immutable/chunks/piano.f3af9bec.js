var v=Object.defineProperty;var g=(e,t,s)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var a=(e,t,s)=>(g(e,typeof t!="symbol"?t+"":t,s),s);const m=""+new URL("../assets/a0.dc3c2e85.mp3",import.meta.url).href,A=""+new URL("../assets/a1.1b1ff663.mp3",import.meta.url).href,G=""+new URL("../assets/a2.b8744b82.mp3",import.meta.url).href,B=""+new URL("../assets/a3.09c40d98.mp3",import.meta.url).href,w=""+new URL("../assets/a4.11c384d7.mp3",import.meta.url).href,R=""+new URL("../assets/a5.bc7d85dc.mp3",import.meta.url).href,q=""+new URL("../assets/a6.a39f1834.mp3",import.meta.url).href,L=""+new URL("../assets/a7.0ce83a41.mp3",import.meta.url).href,U=""+new URL("../assets/damper.391ddc72.mp3",import.meta.url).href,F=""+new URL("../assets/Piano Impulse6.43259355.mp3",import.meta.url).href;async function y(e,t){const s=await fetch(e);if(!s.ok)return{err:s.statusText,code:s.status};const i=await s.arrayBuffer();return{data:await t.decodeAudioData(i)}}class _{constructor(t,s,i,n){a(this,"noteA");a(this,"noteB");a(this,"gainA");a(this,"gainB");a(this,"gain");a(this,"biquadFilter");a(this,"damp");this.noteA=s.createBufferSource(),this.noteB=s.createBufferSource(),this.gainA=s.createGain(),this.gainB=s.createGain(),this.gain=s.createGain(),this.biquadFilter=s.createBiquadFilter(),this.biquadFilter.type="lowpass",this.biquadFilter.connect(i),this.gain.connect(this.biquadFilter),this.gainA.connect(this.gain),this.noteA.connect(this.gainA),this.gainB.connect(this.gain),this.noteB.connect(this.gainB),t<90&&(this.damp=s.createBufferSource(),this.damp.buffer=n,this.damp.connect(i))}on(t,s,i,n,c,o,h,r){this.noteA.buffer=t,this.noteA.playbackRate.value=i,this.biquadFilter.frequency.value=c,this.gainA.gain.value=o,this.gain.gain.value=r,s&&(this.noteB.buffer=s,this.noteB.playbackRate.value=n,this.gainB.gain.value=h,this.noteB.start(0)),this.noteA.start(0)}repress(t){this.gain.gain.setTargetAtTime(0,t,1.1),this.noteA.stop(t+2),this.noteB.stop(t+2),this.damp=void 0}off(t){var s;this.gain.gain.setTargetAtTime(0,t+.03,.08),this.noteA.stop(t+2),this.noteB.stop(t+2),(s=this.damp)==null||s.start(0)}}class P{constructor(t){a(this,"context");a(this,"convolver");a(this,"directGain");a(this,"convGain");a(this,"convGainAfter");a(this,"bufferlists",[]);a(this,"damper");a(this,"sus",!1);a(this,"sustained",[]);a(this,"notes",{});return this.context=t,this.convolver=t.createConvolver(),this.directGain=t.createGain(),this.convGain=t.createGain(),this.convGainAfter=t.createGain(),this.convGain.connect(this.convolver),this.convolver.connect(this.convGainAfter),this.convGainAfter.connect(t.destination),this.directGain.connect(t.destination),this.directGain.connect(this.convGain),this.directGain.gain.value=.5,this.convGain.gain.value=0,this.convGainAfter.gain.value=0,this}async load(){const t=[m,A,G,B,w,R,q,L,U,F],s=await Promise.all(t.map(i=>y(i,this.context)));this.bufferlists=[],s.forEach((i,n)=>{"data"in i?(this.bufferlists.push(i.data),n===8?this.damper=i.data:n===9&&(this.convolver.buffer=i.data)):console.error(`Failed to load audio: ${i.err}`)})}noteOn(t,s){if(console.log(`play note ${t} ${s}`),t<109&&t>20){this.notes[t]&&(this.notes[t].repress(this.context.currentTime),this.sustained.splice(this.sustained.indexOf(t),1));const i=Math.floor((t-21)/12),n=i+1,c=i*12+21,o=2**((t-69)/12)*440,h=s/127;let r=o*(2-(t-21)/50)+3*o*h;t<60&&(r=440*(3-(60-21)/50)+3*o*h);const f=2,l=Math.pow(2,(t-c)/12),u=0,d=0,p=h**1.4;this.notes[t]=new _(t,this.context,this.directGain,this.damper),this.notes[t].on(this.bufferlists[i],this.bufferlists[n],l,u,r,f,d,p)}}noteOff(t){this.sus?this.sustained.push(t):(t<90&&this.notes[t].off(this.context.currentTime),delete this.notes[t])}sustain(t){if(t==127)this.sus=!0,this.convGain.gain.value=1,this.convGainAfter.gain.value=1;else if(t==0){this.sus=!1,this.convGain.gain.value=0,this.convGainAfter.gain.value=0;for(let s=0;s<this.sustained.length;s++)this.notes[this.sustained[s]]&&this.noteOff(this.sustained[s]);this.sustained.length=0}}}export{P};
